<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap.min.css}">
        <link rel="stylesheet"  th:href="@{/css/custom.css}">
        <title>Header</title>
    </head>
    <body>
        <div th:fragment="header" >
            <script type="text/javascript" th:src="@{/libs/jquery-1.4.4.min.js}"></script>

            <div class="navbar navbar-fixed-top navbar-inverse" >
                <div class="navbar-inner">
                    <div class="container">
                        <a href="/" class="brand">Репетиционная база OLOLO</a>
                        <div class="nav-collapse collapse navbar-responsive-collapse" id="actions-div">
                            <ul class="nav">
                                <li><a href="#">Home</a></li>
                                <li><a href="#">Services</a></li>
                                <li class="dropdown">
                                    <a href="#" data-toggle="dropdown" class="dropdown-toggle">Products <b class="caret"></b></a>
                                    <ul class="dropdown-menu">
                                        <li><a href="#">Gadgets</a></li>
                                        <li><a href="#">Accessories</a></li>
                                        <li class="divider"></li>
                                        <li><a href="#">More &raquo;</a></li>
                                    </ul>
                                </li>
                            </ul>

                            <script type='text/javascript' th:inline="javascript">

                                let token = localStorage.getItem("access_token");

                                console.log("TOKEN " + token)

                                if (!token) {
                                    console.log("NO TOKEN");
                                    renderForAnonymous();
                                } else {
                                    console.log("CHECKING ACCESS");
                                    renderForToken(token);
                                }

                                function renderForAnonymous() {
                                    $('#actions-div')
                                        .append(
                                            `<ul class="nav pull-right">' +
                                                <li><a href="/login">Войти</a></li>
                                                <li class="divider-vertical"></li>
                                                <li><a href="/register">Зарегистрироваться</a></li>
                                            </ul>`
                                        );
                                }

                                function renderForToken(token) {
                                    $.ajax({
                                        url: "/checkAccess",
                                        type: "get",
                                        beforeSend: function (xhr) {
                                            xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                                        },
                                        // contentType: "application/json",
                                        // authorization: 'Bearer ' + token,
                                        // data: JSON.stringify(rehearsal),
                                        success: function(user) {
                                            console.log("Access allowed ");
                                            console.log(user);
                                            $('#actions-div')
                                                .append(
                                                    `<ul class="nav pull-right">' +
                                                        <li><a href="/login">Профиль</a></li>
                                                        <li class="divider-vertical"></li>
                                                         <li><a href="/logout">Выйти</a></li>
                                                    </ul>`
                                                );
                                        },
                                        error: function (e) {
                                            console.log(e);
                                        }
                                    });
                                }

                            </script>
    <!--                        <form action="#" class="navbar-search pull-left">-->
    <!--                            <input type="text" placeholder="Search &hellip;" class="search-query">-->
    <!--                        </form>-->
    <!--                        <ul class="nav pull-right">-->
    <!--                            <li><a href="/login">Войти</a></li>-->
    <!--                            <li class="divider-vertical"></li>-->
    <!--                            <li><a href="/register">Зарегистрироваться</a></li>-->
    <!--                        </ul>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>